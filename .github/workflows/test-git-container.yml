name: Test Git Operations in Dev Container

on:
  workflow_dispatch:

jobs:
  test-git-operations:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Test Git Operations in Dev Container
        uses: devcontainers/ci@v0.3
        with:
          imageName: ghcr.io/dolr-ai/github-report-script
          push: never
          runCmd: |
            set -e  # Exit on any error
            
            echo "=== Testing Git Availability ==="
            which git
            git --version
            
            echo -e "\n=== Current Git Status ==="
            git status
            
            echo -e "\n=== Current Branch ==="
            git branch -v
            
            echo -e "\n=== Git Remote Info ==="
            git remote -v
            
            echo -e "\n=== Creating Test File ==="
            echo "test-$(date +%s)" > test-git-in-container.txt
            
            echo -e "\n=== Git Status After Change ==="
            git status
            
            echo -e "\n=== Configuring Git User ==="
            git config --global user.name "github-actions[bot]"
            git config --global user.email "github-actions[bot]@users.noreply.github.com"
            git config --list | grep user
            
            echo -e "\n=== Checking GITHUB_TOKEN availability ==="
            if [ -n "$GITHUB_TOKEN" ]; then
              echo "✓ GITHUB_TOKEN is available (length: ${#GITHUB_TOKEN})"
            else
              echo "✗ GITHUB_TOKEN is NOT available"
              exit 1
            fi
            
            echo -e "\n=== Configuring Git Authentication ==="
            git config --global url."https://x-access-token:${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"
            echo "✓ Git authentication configured"
            
            echo -e "\n=== Adding File ==="
            git add test-git-in-container.txt
            
            echo -e "\n=== Git Status After Add ==="
            git status
            
            echo -e "\n=== Committing ==="
            git commit -m "test: Validate git operations in dev container [skip ci]"
            echo "✓ Commit created"
            
            echo -e "\n=== Testing Push (DRY RUN) ==="
            git push --dry-run origin HEAD
            echo "✓ Dry run successful"
            
            echo -e "\n=== Actual Push ==="
            git push origin HEAD:${GITHUB_REF#refs/heads/}
            echo "✓ Push successful"
            
            echo -e "\n=== TEST PASSED ==="
            echo "All git operations completed successfully!"
            echo "File 'test-git-in-container.txt' should now be in the repository"
          env: |
            GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}

      - name: Verify push succeeded
        run: |
          echo "Fetching latest changes to verify push..."
          git fetch origin
          git log -1 --pretty=format:"%h - %s" origin/${{ github.ref_name }}
          
          if git show origin/${{ github.ref_name }}:test-git-in-container.txt > /dev/null 2>&1; then
            echo "✓ TEST FILE FOUND - Push was successful!"
          else
            echo "✗ TEST FILE NOT FOUND - Push may have failed"
            exit 1
          fi
